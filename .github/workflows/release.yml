name: Release Creation

on:
  push:
    tags:
      - '*'  # Any tag will trigger (e.g. 1.0.1 or v1.0.1)

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Derive version from tag
        id: vars
        run: |
          RAW_TAG="${GITHUB_REF#refs/tags/}"
          # Strip leading v if present for numeric version
          VERSION=${RAW_TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "raw_tag=$RAW_TAG" >> $GITHUB_OUTPUT

      - name: Update module.json (in workspace copy)
        run: |
          VERSION='${{ steps.vars.outputs.version }}'
          sed -i "s|\"version\":.*|\"version\": \"$VERSION\",|" module.json
          sed -i "s|\"download\":.*|\"download\": \"https://github.com/${{ github.repository }}/releases/download/${{ steps.vars.outputs.raw_tag }}/module.zip\",|" module.json
          sed -i "s|\"manifest\":.*|\"manifest\": \"https://github.com/${{ github.repository }}/releases/download/${{ steps.vars.outputs.raw_tag }}/module.json\"|" module.json
          cat module.json

      - name: Create distributable zip
        run: zip -r module.zip lang/ scripts/ styles/ templates/ module.json README.md LICENSE

      - name: Commit updated module.json (optional sync)
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          if git diff --quiet module.json; then echo "No changes to commit."; else git add module.json; git commit -m "chore: bump version to ${{ steps.vars.outputs.version }}"; git push; fi

      - name: Create GitHub Release with assets
        uses: softprops/action-gh-release@v2
        with:
          name: "Release ${{ steps.vars.outputs.raw_tag }}"
          tag_name: "${{ steps.vars.outputs.raw_tag }}"
          draft: false
          prerelease: false
          files: |
            module.json
            module.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
